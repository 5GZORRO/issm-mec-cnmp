# Copyright 2021 - 2022 IBM Corporation

# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at

# http://www.apache.org/licenses/LICENSE-2.0

# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# This template runs on the target cluster
#
# This template get called out from fiveg-subnet-configure Workflow defined in
# gitops github pointed by the channel
apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: fiveg-subnet-configure
spec:
  templates:
  - name: handlerequest
    dag:
      tasks:
      - name: smf-register-upf
        template: smf-register-upf
      

  - name: smf-register-upf
    script:
      image: docker.pkg.github.com/5gzorro/issm/python:alpine3.6-kafka-v0.1
      imagePullPolicy: IfNotPresent
      command: [python]
      source: |
        import json
        import requests
        import sys
        core_namespace = "{{workflow.parameters.core_namespace}}"
        smf_name = "{{workflow.parameters.smf_name}}"
        payload = {
          "up_nodes": {
            "upf-{{workflow.name}}": {
              "type": "UPF",
              "node_id": "{{workflow.parameters.upf_sbi}}",
              "sNssaiUpfInfos": [
                {
                  "sNssai": {
                    "sst": {{workflow.parameters.sst}},
                    "sd": "{{workflow.parameters.sd}}"
                  },
                  "dnnUpfInfoList": [
                    {
                      "dnn": "internet",
                      # "pools": [{"cidr": "{{workflow.parameters.pool}}"}]
                    }
                  ]
                }
              ],
              "interfaces": [
                {
                  "interfaceType": "N3",
                  "endpoints": ["{{workflow.parameters.upf_up}}"],
                  "networkInstance": "internet"
                },
                {
                  "interfaceType": "N9",
                  "endpoints": ["{{workflow.parameters.upf_up}}"],
                  "networkInstance": "internet"
                }
              ]
            }
          }
        }

        pool = "{{workflow.parameters.pool}}"
        if pool != "0.0.0.0/16":
            sys.stdout.write('Add pool [%s]\n' % pool)
            # TODO: assuming UPF is related to a single slice
            payload["up_nodes"]["upf-{{workflow.name}}"]["sNssaiUpfInfos"][0]["dnnUpfInfoList"][0]["pools"] = [{"cidr": "{{workflow.parameters.pool}}"}]

        headers = {'Content-Type': 'application/json'}
        # TODO: examine rc
        # TODO: change to smf_name
        r= requests.post('http://%s.%s:8000/upi/v1/upf' % (smf_name, core_namespace),
            json=payload,
            headers=headers)
        sys.stdout.write('Add r.text [%s]\n' % r.text)
