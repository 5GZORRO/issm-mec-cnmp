# submit this from ACM
apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  name: fiveg-core-acm
spec:
  entrypoint: handlerequest
  arguments:
    parameters:
    - name: registry
      value: "OVERRIDE"

    - name: networks

    - name: cluster_core
      value: paris-core

  templates:
  - name: handlerequest
    dag:
      tasks:
      - name: create-core-subscription
        # TODO: wait on status
        template: create-core-subscription

  - name: create-core-subscription
    resource:
      action: create
      setOwnerReference: true
      manifest: |
        apiVersion: apps.open-cluster-management.io/v1
        kind: Subscription
        metadata:
          annotations:
            apps.open-cluster-management.io/github-branch: multi-cluster-1
            apps.open-cluster-management.io/github-path: core-wf
          name: {{workflow.name}}
        spec:
          channel: gitops-chn-ns/gitops
          placement:
            clusters:
            - name: {{workflow.parameters.cluster_core}}
          packageOverrides:
          - packageName: fiveg-core
            packageOverrides:
            - path: metadata.name
              value: {{workflow.name}}
            - path: spec.arguments.parameters
              value:
              - name: registry
                value: {{workflow.parameters.registry}}

              - name: networks
                value: |
                  {{workflow.parameters.networks}}
